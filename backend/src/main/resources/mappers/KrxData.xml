<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.financeHub.krx.mapper.KrxDataMapper">

    <!-- KOSPI -->
    <insert id="batchInsertKospi" parameterType="list">
        INSERT INTO financeHub.kospi_daily_trading
        (data_hash, bas_dd, idx_clss, idx_nm, clsprc_idx, cmpprevdd_idx, fluc_rt, opnprc_idx, hgprc_idx, lwprc_idx, acc_trdvol, acc_trdval, mktcap)
        VALUES
        <foreach collection="list" item="item" separator=",">
            (#{item.dataHash}, #{item.basDd}, #{item.idxClss}, #{item.idxNm}, #{item.clsprcIdx}, #{item.cmpprevddIdx}, #{item.flucRt}, #{item.opnprcIdx}, #{item.hgprcIdx}, #{item.lwprcIdx}, #{item.accTrdvol}, #{item.accTrdval}, #{item.mktcap})
        </foreach>
        ON CONFLICT (data_hash) DO NOTHING
    </insert>

    <select id="findExistingKospiHashes" resultType="string">
        SELECT data_hash FROM financeHub.kospi_daily_trading
        WHERE data_hash IN
        <foreach collection="hashes" item="hash" open="(" separator="," close=")">
            #{hash}
        </foreach>
    </select>

    <select id="selectLatestKospi" resultType="com.example.financeHub.krx.model.KospiDailyTradingDTO">
        SELECT bas_dd AS basDd, idx_clss AS idxClss, idx_nm AS idxNm, clsprc_idx AS clsprcIdx,
               cmpprevdd_idx AS cmpprevddIdx, fluc_rt AS flucRt, opnprc_idx AS opnprcIdx,
               hgprc_idx AS hgprcIdx, lwprc_idx AS lwprcIdx, acc_trdvol AS accTrdvol,
               acc_trdval AS accTrdval, mktcap, data_hash AS dataHash
        FROM financeHub.kospi_daily_trading
        WHERE bas_dd = (SELECT MAX(bas_dd) FROM financeHub.kospi_daily_trading)
        ORDER BY idx_nm
    </select>

    <!-- KOSDAQ -->
    <insert id="batchInsertKosdaq" parameterType="list">
        INSERT INTO financeHub.kosdaq_daily_trading
        (data_hash, bas_dd, idx_clss, idx_nm, clsprc_idx, cmpprevdd_idx, fluc_rt, opnprc_idx, hgprc_idx, lwprc_idx, acc_trdvol, acc_trdval, mktcap)
        VALUES
        <foreach collection="list" item="item" separator=",">
            (#{item.dataHash}, #{item.basDd}, #{item.idxClss}, #{item.idxNm}, #{item.clsprcIdx}, #{item.cmpprevddIdx}, #{item.flucRt}, #{item.opnprcIdx}, #{item.hgprcIdx}, #{item.lwprcIdx}, #{item.accTrdvol}, #{item.accTrdval}, #{item.mktcap})
        </foreach>
        ON CONFLICT (data_hash) DO NOTHING
    </insert>

    <select id="findExistingKosdaqHashes" resultType="string">
        SELECT data_hash FROM financeHub.kosdaq_daily_trading
        WHERE data_hash IN
        <foreach collection="hashes" item="hash" open="(" separator="," close=")">
            #{hash}
        </foreach>
    </select>

    <select id="selectLatestKosdaq" resultType="com.example.financeHub.krx.model.KosdaqDailyTradingDTO">
        SELECT bas_dd AS basDd, idx_clss AS idxClss, idx_nm AS idxNm, clsprc_idx AS clsprcIdx,
               cmpprevdd_idx AS cmpprevddIdx, fluc_rt AS flucRt, opnprc_idx AS opnprcIdx,
               hgprc_idx AS hgprcIdx, lwprc_idx AS lwprcIdx, acc_trdvol AS accTrdvol,
               acc_trdval AS accTrdval, mktcap, data_hash AS dataHash
        FROM financeHub.kosdaq_daily_trading
        WHERE bas_dd = (SELECT MAX(bas_dd) FROM financeHub.kosdaq_daily_trading)
        ORDER BY idx_nm
    </select>

    <!-- Gold Market -->
    <insert id="batchInsertGoldMarket" parameterType="list">
        INSERT INTO financeHub.gold_market_daily_trading
        (data_hash, bas_dd, isu_cd, isu_nm, tdd_clsprc, cmpprevdd_prc, fluc_rt, tdd_opnprc, tdd_hgprc, tdd_lwprc, acc_trdvol, acc_trdval)
        VALUES
        <foreach collection="list" item="item" separator=",">
            (#{item.dataHash}, #{item.basDd}, #{item.isuCd}, #{item.isuNm}, #{item.tddClsprc}, #{item.cmpprevddPrc}, #{item.flucRt}, #{item.tddOpnprc}, #{item.tddHgprc}, #{item.tddLwprc}, #{item.accTrdvol}, #{item.accTrdval})
        </foreach>
        ON CONFLICT (data_hash) DO NOTHING
    </insert>

    <select id="findExistingGoldMarketHashes" resultType="string">
        SELECT data_hash FROM financeHub.gold_market_daily_trading
        WHERE data_hash IN
        <foreach collection="hashes" item="hash" open="(" separator="," close=")">
            #{hash}
        </foreach>
    </select>

    <select id="selectLatestGoldMarket" resultType="com.example.financeHub.krx.model.GoldMarketDailyTradingDTO">
        SELECT bas_dd AS basDd, isu_cd AS isuCd, isu_nm AS isuNm, tdd_clsprc AS tddClsprc,
               cmpprevdd_prc AS cmpprevddPrc, fluc_rt AS flucRt, tdd_opnprc AS tddOpnprc,
               tdd_hgprc AS tddHgprc, tdd_lwprc AS tddLwprc, acc_trdvol AS accTrdvol,
               acc_trdval AS accTrdval, data_hash AS dataHash
        FROM financeHub.gold_market_daily_trading
        WHERE bas_dd = (SELECT MAX(bas_dd) FROM financeHub.gold_market_daily_trading)
        ORDER BY isu_nm
    </select>

    <!-- Oil Market -->
    <insert id="batchInsertOilMarket" parameterType="list">
        INSERT INTO financeHub.oil_market_daily_trading
        (data_hash, bas_dd, oil_nm, wt_avg_prc, wt_dis_avg_prc, acc_trdvol, acc_trd_val)
        VALUES
        <foreach collection="list" item="item" separator=",">
            (#{item.dataHash}, #{item.basDd}, #{item.oilNm}, #{item.wtAvgPrc}, #{item.wtDisAvgPrc}, #{item.accTrdvol}, #{item.accTrdVal})
        </foreach>
        ON CONFLICT (data_hash) DO NOTHING
    </insert>

    <select id="findExistingOilMarketHashes" resultType="string">
        SELECT data_hash FROM financeHub.oil_market_daily_trading
        WHERE data_hash IN
        <foreach collection="hashes" item="hash" open="(" separator="," close=")">
            #{hash}
        </foreach>
    </select>

    <select id="selectLatestOilMarket" resultType="com.example.financeHub.krx.model.OilMarketDailyTradingDTO">
        SELECT bas_dd AS basDd, oil_nm AS oilNm, wt_avg_prc AS wtAvgPrc,
               wt_dis_avg_prc AS wtDisAvgPrc, acc_trdvol AS accTrdvol,
               acc_trd_val AS accTrdVal, data_hash AS dataHash
        FROM financeHub.oil_market_daily_trading
        WHERE bas_dd = (SELECT MAX(bas_dd) FROM financeHub.oil_market_daily_trading)
        ORDER BY oil_nm
    </select>

    <!-- Stock (개별 종목) -->
    <insert id="batchInsertStock" parameterType="list">
        INSERT INTO financeHub.stock_daily_trading
        (data_hash, bas_dd, isu_cd, isu_srt_cd, isu_nm, mkt_nm, sect_tp_nm, tdd_clsprc, cmpprevdd_prc, fluc_rt, tdd_opnprc, tdd_hgprc, tdd_lwprc, acc_trdvol, acc_trdval, mktcap, list_shrs)
        VALUES
        <foreach collection="list" item="item" separator=",">
            (#{item.dataHash}, #{item.basDd}, #{item.isuCd}, #{item.isuSrtCd}, #{item.isuNm}, #{item.mktNm}, #{item.sectTpNm}, #{item.tddClsprc}, #{item.cmpprevddPrc}, #{item.flucRt}, #{item.tddOpnprc}, #{item.tddHgprc}, #{item.tddLwprc}, #{item.accTrdvol}, #{item.accTrdval}, #{item.mktcap}, #{item.listShrs})
        </foreach>
        ON CONFLICT (data_hash) DO NOTHING
    </insert>

    <select id="findExistingStockHashes" resultType="string">
        SELECT data_hash FROM financeHub.stock_daily_trading
        WHERE data_hash IN
        <foreach collection="hashes" item="hash" open="(" separator="," close=")">
            #{hash}
        </foreach>
    </select>

    <select id="selectTopGainers" resultType="com.example.financeHub.krx.model.StockDailyTradingDTO">
        SELECT bas_dd AS basDd, isu_cd AS isuCd, isu_srt_cd AS isuSrtCd, isu_nm AS isuNm,
               mkt_nm AS mktNm, sect_tp_nm AS sectTpNm, tdd_clsprc AS tddClsprc,
               cmpprevdd_prc AS cmpprevddPrc, fluc_rt AS flucRt, tdd_opnprc AS tddOpnprc,
               tdd_hgprc AS tddHgprc, tdd_lwprc AS tddLwprc, acc_trdvol AS accTrdvol,
               acc_trdval AS accTrdval, mktcap, list_shrs AS listShrs, data_hash AS dataHash
        FROM financeHub.stock_daily_trading
        WHERE bas_dd = (SELECT MAX(bas_dd) FROM financeHub.stock_daily_trading)
        ORDER BY CAST(REPLACE(fluc_rt, ',', '') AS DECIMAL) DESC
        LIMIT #{limit}
    </select>

    <select id="selectTopVolume" resultType="com.example.financeHub.krx.model.StockDailyTradingDTO">
        SELECT bas_dd AS basDd, isu_cd AS isuCd, isu_srt_cd AS isuSrtCd, isu_nm AS isuNm,
               mkt_nm AS mktNm, sect_tp_nm AS sectTpNm, tdd_clsprc AS tddClsprc,
               cmpprevdd_prc AS cmpprevddPrc, fluc_rt AS flucRt, tdd_opnprc AS tddOpnprc,
               tdd_hgprc AS tddHgprc, tdd_lwprc AS tddLwprc, acc_trdvol AS accTrdvol,
               acc_trdval AS accTrdval, mktcap, list_shrs AS listShrs, data_hash AS dataHash
        FROM financeHub.stock_daily_trading
        WHERE bas_dd = (SELECT MAX(bas_dd) FROM financeHub.stock_daily_trading)
        ORDER BY CAST(REPLACE(acc_trdvol, ',', '') AS BIGINT) DESC
        LIMIT #{limit}
    </select>

</mapper>
